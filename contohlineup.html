<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Haikyuu Volleyball Lineup Builder</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <style>
    /* ... [your entire CSS unchanged] ... */
    body {
      font-family: 'Montserrat', Arial, sans-serif;
      background: radial-gradient(circle at 60% 20%, #ffe066 0%, #ffd700 60%, #ffc300 100%);
      background-image:
        url('data:image/svg+xml;utf8,<svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="60" cy="60" r="58" stroke="orange" stroke-width="3"/><path d="M2,60 Q60,10 118,60" stroke="white" stroke-width="3" fill="none"/><path d="M2,60 Q60,110 118,60" stroke="white" stroke-width="3" fill="none"/><path d="M60,2 Q110,60 60,118" stroke="white" stroke-width="3" fill="none"/><path d="M60,2 Q10,60 60,118" stroke="white" stroke-width="3" fill="none"/></svg>');
      background-repeat: repeat;
      min-height: 100vh;
      margin: 0;
    }
    /* ... rest of your CSS ... */
  </style>
</head>
<body>
  <!-- ... unchanged ... -->
  <h1>Haikyuu Volleyball Lineup Builder</h1>
  <div class="menu-bar">
    <input type="file" id="img-upload" accept="image/*" multiple style="display: none"/>
    <button class="btn" onclick="document.getElementById('img-upload').click()">Upload Character</button>
    <button class="btn" onclick="resetLineup()">Reset Lineup</button>
    <button class="btn" onclick="saveCurrentLineup()">Save Lineup</button>
  </div>
  <div class="download-bar" id="download-bar" style="display:none;">
    <button class="download-btn" onclick="downloadLineup()">Download Lineup as PNG</button>
  </div>
  <div id="upload-list"></div>
  <div class="lineup-bg-wrapper" id="lineup-board">
    <!-- ... unchanged lineup slots ... -->
    <div class="court-border"></div>
    <div class="net"></div>
    <div class="overlay-board"></div>
    <!-- Main lineup slots (6) -->
    <div class="drop-slot" data-type="main" data-slot="0" style="left: 160px; top: 70px;">
      <span class="slot-type-label">WS</span>
    </div>
    <div class="drop-slot" data-type="main" data-slot="1" style="left: 400px; top: 40px;">
      <span class="slot-type-label">S</span>
    </div>
    <div class="drop-slot" data-type="main" data-slot="2" style="left: 640px; top: 70px;">
      <span class="slot-type-label">WS</span>
    </div>
    <div class="drop-slot" data-type="main" data-slot="3" style="left: 250px; top: 250px;">
      <span class="slot-type-label">MB</span>
    </div>
    <div class="drop-slot" data-type="main" data-slot="4" style="left: 520px; top: 250px;">
      <span class="slot-type-label">MB</span>
    </div>
    <div class="drop-slot" data-type="main" data-slot="5" style="left: 780px; top: 250px;">
      <span class="slot-type-label">MB</span>
    </div>
    <div class="drop-slot coach-slot" data-type="coach" data-slot="coach" style="left: 30px; top: 320px; width:90px; height:120px;">
      <span class="slot-type-label coach-label">COACH</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub0" style="left: 160px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub1" style="left: 270px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub2" style="left: 380px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub3" style="left: 490px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub4" style="left: 600px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
    <div class="drop-slot bench-slot" data-type="bench" data-slot="sub5" style="left: 710px; top: 470px; width:90px; height:110px;">
      <span class="slot-type-label bench-label">SUB</span>
    </div>
  </div>
</div>
<!-- html2canvas via CDN for PNG export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* --- BEGIN HTTD IMAGE SELECTOR INTEGRATION --- */
const HTTD_IMAGE_PATH = "https://raw.githubusercontent.com/DeBuDDi/debuddi.github.io/d005673a24dfdbef5400400c1b4793a520a9dd9b/httd/";
const httdImageFiles = [
  "1.png",
  "2.png",
  "3.png",
  "4.png",
  "5.png",
  "6.png",
  "7.png",
  "8.png",
  "9.png",
  "10.png",
  // Add more if needed, e.g. "11.png"
];
let httdImages = httdImageFiles.map(filename => HTTD_IMAGE_PATH + filename);
let showingHTTD = false;
/* --- END HTTD IMAGE SELECTOR INTEGRATION --- */

let uploadedImages = [];
let currentDragIndex = null;
let selectedUploadIndex = null; // For touch/mobile selection

// --- Upload Section ---
document.getElementById('img-upload').addEventListener('change', function(e) {
  for (let file of e.target.files) {
    let reader = new FileReader();
    reader.onload = function(evt) {
      uploadedImages.push(evt.target.result);
      renderUploaded();
      saveState(); // save images to localStorage when uploaded
    };
    reader.readAsDataURL(file);
  }
});

/* --- MODIFIED renderUploaded so it doesn't show HTTD images unless triggered --- */
function renderUploaded() {
  if (showingHTTD) return; // Don't show uploads if HTTD is active
  const list = document.getElementById('upload-list');
  list.innerHTML = '';
  uploadedImages.forEach((src, i) => {
    let img = document.createElement('img');
    img.src = src;
    img.className = 'upload-thumb' + (selectedUploadIndex === i ? ' selected' : '');
    img.draggable = true;
    img.ondragstart = () => currentDragIndex = i;
    img.title = 'Drag to lineup';

    // --- Touch support for mobile: tap to select for assignment ---
    img.addEventListener('touchstart', function(e) {
      e.preventDefault();
      if (selectedUploadIndex === i) {
        selectedUploadIndex = null;
      } else {
        selectedUploadIndex = i;
      }
      renderUploaded();
    });

    // Desktop: click to select also works
    img.addEventListener('click', function(e) {
      if (selectedUploadIndex === i) {
        selectedUploadIndex = null;
      } else {
        selectedUploadIndex = i;
      }
      renderUploaded();
    });

    list.appendChild(img);
  });
}

/* --- HTTD ONLY RENDER --- */
function renderHTTDOnly() {
  const list = document.getElementById('upload-list');
  list.innerHTML = '';
  httdImages.forEach((src, i) => {
    let img = document.createElement('img');
    img.src = src;
    img.className = 'upload-thumb' + (selectedUploadIndex === 'httd_' + i ? ' selected' : '');
    img.draggable = true;
    img.ondragstart = () => currentDragIndex = 'httd_' + i;
    img.title = 'Drag to lineup';

    img.addEventListener('touchstart', function(e) {
      e.preventDefault();
      selectedUploadIndex = 'httd_' + i;
      renderHTTDOnly();
    });

    img.addEventListener('click', function(e) {
      selectedUploadIndex = 'httd_' + i;
      renderHTTDOnly();
    });

    list.appendChild(img);
  });
}

function showHTTDImages() {
  showingHTTD = true;
  renderHTTDOnly();
}

function hideHTTDImages() {
  showingHTTD = false;
  renderUploaded();
}

/* --- Drag & Drop for Lineup Slots --- */
function makeLabel(label, onEdit) {
  let labelDiv = document.createElement('div');
  labelDiv.className = 'player-label';
  labelDiv.innerText = label || "Click to Edit";
  labelDiv.onclick = function(e) {
    e.stopPropagation();
    let input = document.createElement('input');
    input.type = 'text';
    input.value = labelDiv.innerText === "Click to Edit" ? "" : labelDiv.innerText;
    input.className = 'label-edit';
    input.onblur = function() {
      labelDiv.innerText = input.value || "Click to Edit";
      onEdit(labelDiv.innerText);
      labelDiv.style.display = '';
      input.remove();
    };
    input.onkeydown = function(ev) {
      if(ev.key === 'Enter') input.blur();
    };
    labelDiv.style.display = 'none';
    labelDiv.parentNode.insertBefore(input, labelDiv);
    input.focus();
  };
  return labelDiv;
}

function getInitialLabels() {
  return {
    '0': '', '1': '', '2': '', '3': '', '4': '', '5': '',
    'coach': '',
    'sub0': '', 'sub1': '', 'sub2': '', 'sub3': '', 'sub4': '', 'sub5': ''
  }
}
let slotLabels = getInitialLabels();
let slotImages = {};

// --- Save/load state with uploads ---
function saveState() {
  let state = { slotLabels, slotImages, uploadedImages };
  window.localStorage.setItem('haikyuu_lineup_state', JSON.stringify(state));
}
function loadState() {
  let state = window.localStorage.getItem('haikyuu_lineup_state');
  if (state) {
    try {
      let { slotLabels: l, slotImages: i, uploadedImages: imgs } = JSON.parse(state);
      slotLabels = l || getInitialLabels();
      slotImages = i || {};
      uploadedImages = imgs || [];
      renderUploaded();
      document.querySelectorAll('.drop-slot').forEach(slot => renderSlot(slot));
    } catch {}
  }
}
loadState();

/* --- MODIFIED drop-slot listeners for HTTD logic --- */
document.querySelectorAll('.drop-slot').forEach(slot => {
  slot.ondragover = e => { e.preventDefault(); slot.classList.add('dragover'); };
  slot.ondragleave = () => slot.classList.remove('dragover');
  slot.ondrop = function(e) {
    e.preventDefault(); slot.classList.remove('dragover');
    // HTTD drag support
    if (typeof currentDragIndex === 'string' && currentDragIndex.startsWith('httd_')) {
      let idx = Number(currentDragIndex.replace('httd_', ''));
      setSlotImage(slot, httdImages[idx]);
      hideHTTDImages();
      currentDragIndex = null;
      selectedUploadIndex = null;
      return;
    }
    if (currentDragIndex !== null && uploadedImages[currentDragIndex]) {
      setSlotImage(slot, uploadedImages[currentDragIndex]);
    }
    else if (window._draggingSlot && window._draggingSlot !== slot) {
      setSlotImage(slot, slotImages[window._draggingSlot.dataset.slot], slotLabels[window._draggingSlot.dataset.slot]);
      clearSlot(window._draggingSlot);
    }
    currentDragIndex = null;
    window._draggingSlot = null;
    selectedUploadIndex = null; // Clear touch selection after drop
    renderUploaded();
  };
  slot.addEventListener('mousedown', function(e) {
    if(e.target.classList.contains('char-img')) {
      window._draggingSlot = slot;
    }
  });

  // --- Touch support: tap on slot to assign selected image ---
  slot.addEventListener('touchstart', function(e) {
    const slotKey = slot.dataset.slot;
    // Only assign if an image is selected and slot is empty or replaceable
    if (typeof selectedUploadIndex === 'string' && selectedUploadIndex.startsWith('httd_')) {
      e.preventDefault();
      let idx = Number(selectedUploadIndex.replace('httd_', ''));
      slot.classList.add('touch-highlight');
      setTimeout(() => {
        setSlotImage(slot, httdImages[idx]);
        slot.classList.remove('touch-highlight');
        selectedUploadIndex = null;
        hideHTTDImages();
      }, 120);
      return;
    }
    if(selectedUploadIndex !== null && uploadedImages[selectedUploadIndex]) {
      e.preventDefault();
      slot.classList.add('touch-highlight');
      setTimeout(() => {
        setSlotImage(slot, uploadedImages[selectedUploadIndex]);
        slot.classList.remove('touch-highlight');
        selectedUploadIndex = null;
        renderUploaded();
      }, 120);
    } else if (!slotImages[slotKey]) {
      showHTTDImages();
    }
  });

  // Desktop: click on slot to assign selected image OR show HTTD
  slot.addEventListener('click', function(e) {
    const slotKey = slot.dataset.slot;
    if (typeof selectedUploadIndex === 'string' && selectedUploadIndex.startsWith('httd_')) {
      let idx = Number(selectedUploadIndex.replace('httd_', ''));
      setSlotImage(slot, httdImages[idx]);
      hideHTTDImages();
      selectedUploadIndex = null;
    }
    else if(selectedUploadIndex !== null && uploadedImages[selectedUploadIndex]) {
      setSlotImage(slot, uploadedImages[selectedUploadIndex]);
      selectedUploadIndex = null;
      renderUploaded();
    } else if (!slotImages[slotKey]) {
      showHTTDImages();
    } else {
      hideHTTDImages();
    }
  });

  renderSlot(slot);
});

/* --- PATCHED setSlotImage to always hide HTTD images after assignment --- */
function setSlotImage(slot, imgSrc, label) {
  slot.innerHTML = '';
  let slotKey = slot.dataset.slot;
  slotImages[slotKey] = imgSrc;
  slotLabels[slotKey] = label || slotLabels[slotKey] || '';
  let img = document.createElement('img');
  img.src = imgSrc;
  img.className = 'char-img';
  img.draggable = true;
  img.ondragstart = function(e) {
    window._draggingSlot = slot;
    currentDragIndex = null;
    e.dataTransfer.setData('text/plain', '');
  };
  slot.appendChild(img);

  let labelDiv = makeLabel(slotLabels[slotKey], val => {
    slotLabels[slotKey] = val;
    saveState();
  });
  slot.appendChild(labelDiv);

  let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
  if (slotType) {
    slot.insertBefore(slotType, slot.firstChild);
  }
  hideHTTDImages(); // Always hide HTTD browser after selection
  saveState();
}
function clearSlot(slot) {
  let slotKey = slot.dataset.slot;
  slot.innerHTML = '';
  slotImages[slotKey] = null;
  slotLabels[slotKey] = '';
  let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
  if (slotType) {
    slot.appendChild(slotType);
  }
}

function renderSlot(slot) {
  let slotKey = slot.dataset.slot;
  slot.innerHTML = '';
  if(slotImages[slotKey]) {
    setSlotImage(slot, slotImages[slotKey], slotLabels[slotKey]);
  } else {
    let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
    if (slotType) slot.appendChild(slotType);
  }
}

function resetLineup() {
  slotLabels = getInitialLabels();
  slotImages = {};
  document.querySelectorAll('.drop-slot').forEach(slot => renderSlot(slot));
  saveState();
  document.getElementById('download-bar').style.display = "none";
}

// --- Save Current Lineup Button (manual save) ---
function saveCurrentLineup() {
  saveState();
  alert('Your current lineup, uploads, and edits have been saved!');
  document.getElementById('download-bar').style.display = "flex";
}

// --- Download Lineup as PNG ---
function downloadLineup() {
  const board = document.getElementById('lineup-board');
  // Remove focus state on any inputs (labels)
  document.activeElement.blur();
  html2canvas(board, {
    backgroundColor: null,
    useCORS: true,
    scale: 2
  }).then(function(canvas) {
    let link = document.createElement('a');
    link.download = "haikyuu_lineup.png";
    link.href = canvas.toDataURL();
    document.body.appendChild(link);
    link.click();
    setTimeout(() => document.body.removeChild(link), 100);
  });
}
/* --- Ensure upload list only shows uploads on DOMContentLoaded --- */
window.addEventListener('DOMContentLoaded', function() {
  hideHTTDImages();
});
</script>
</body>
</html>
