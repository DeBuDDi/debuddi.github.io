<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>DeBuDDi ‚Äî Latest Videos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#191919;
      --card:#272727;
      --accent:#ffa500;
      --yt:#ff0000;
      --muted:#cfcfcf;
    }
    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .wrap{
      padding:48px 6vw;
      max-width:1100px;
      margin:0 auto;
    }

    .card{
      background:var(--card);
      border-radius:18px;
      padding:28px;
      box-shadow:0 6px 28px rgba(0,0,0,.6);
    }

    h1{
      margin:0 0 8px 0;
      color:var(--accent);
      font-size:1.6rem;
      display:flex;
      align-items:center;
      gap:.6rem;
    }

    p.lead{
      margin:0 0 18px 0;
      color:var(--muted);
    }

    .top-row{
      display:flex;
      gap:18px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .yt-link{
      display:inline-flex;
      align-items:center;
      gap:.6rem;
      text-decoration:none;
      color:#fff;
      background:var(--yt);
      padding:.45rem .9rem;
      border-radius:10px;
      font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,.35);
    }
    .yt-link img{ width:20px; height:20px; }

    .player{
      margin:22px auto;
      max-width:720px;
      width:100%;
      border-radius:14px;
      overflow:hidden;
      background:#000;
      box-shadow:0 8px 30px rgba(0,0,0,.6);
    }
    .player iframe{
      width:100%;
      height:405px;
      border:0;
      display:block;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:14px;
      margin-top:22px;
    }

    .thumb{
      background:#111;
      border-radius:12px;
      overflow:hidden;
      cursor:pointer;
      transition:transform .14s ease, box-shadow .14s ease;
      display:flex;
      flex-direction:column;
      min-height:170px;
    }
    .thumb:hover{
      transform:translateY(-6px);
      box-shadow:0 16px 32px rgba(0,0,0,.6);
    }
    .thumb img{
      width:100%;
      height:110px;
      object-fit:cover;
      display:block;
      background:#000;
    }
    .meta{
      padding:.7rem .8rem;
      display:flex;
      gap:.6rem;
      align-items:flex-start;
      justify-content:space-between;
      color:var(--muted);
      font-size:.92rem;
    }
    .meta .title{
      font-weight:600;
      color:#fff;
      font-size:.95rem;
      line-height:1.18;
      max-height:2.6rem;
      overflow:hidden;
    }
    .meta .date{
      font-size:.82rem;
      color:#bdbdbd;
      white-space:nowrap;
    }

    .controls{
      margin-top:16px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:center;
    }
    .btn{
      background:transparent;
      color:var(--accent);
      border:2px solid rgba(255,165,0,.12);
      padding:.5rem .9rem;
      border-radius:10px;
      cursor:pointer;
    }

    hr{
      border:0;
      border-top:1px solid rgba(255,165,0,.12);
      margin:22px 0 0 0;
    }

    @media (max-width:900px){
      .grid{ grid-template-columns:repeat(2,1fr); }
      .player iframe{ height:320px; }
    }
    @media (max-width:520px){
      .grid{ grid-template-columns:1fr; }
      .player iframe{ height:220px; }
    }

    .play-overlay{
      position:relative;
    }
    .play-overlay::after{
      content: '‚ñ∫';
      position:absolute;
      left:8px;
      bottom:8px;
      background:var(--yt);
      color:#fff;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      font-weight:700;
      box-shadow:0 6px 16px rgba(0,0,0,.45);
    }
    
    .error-box{
      background:#ff4444;
      color:#fff;
      padding:12px;
      border-radius:8px;
      margin:10px 0;
    }
    
    .debug-info{
      background:#333;
      color:#0f0;
      padding:8px;
      border-radius:4px;
      font-family:monospace;
      font-size:0.9em;
      margin-top:10px;
      max-height:100px;
      overflow-y:auto;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card" id="video-card">
      <div class="top-row">
        <div>
          <h1>üé¨ DeBuDDi ‚Äî Latest Videos</h1>
          <p class="lead">Below are the 9 most recently published videos on the DeBuDDi channel. Click any thumbnail to play it in the embedded player.</p>
        </div>
        <div style="display:flex;gap:12px;align-items:center;">
          <a class="yt-link" href="https://www.youtube.com/@DeBuDDi" target="_blank" rel="noopener">
            <img src="https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png" alt="YouTube">
            <span>@DeBuDDi</span>
          </a>
          <button class="btn" id="refresh">Refresh</button>
        </div>
      </div>

      <div class="player" id="player">
        <iframe id="player-iframe" src="" title="DeBuDDi Player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>

      <div class="grid" id="videos-grid" aria-live="polite" aria-busy="true">
        <!-- thumbnails inserted here -->
      </div>

      <div class="controls" style="margin-top:18px;">
        <a id="open-channel" class="yt-link" href="https://www.youtube.com/@DeBuDDi/videos" target="_blank" rel="noopener">
          <img src="https://upload.wikimedia.org/wikipedia/commons/4/42/YouTube_icon_%282013-2017%29.png" alt="YouTube"> View All Videos
        </a>
      </div>

      <hr>

      <p style="text-align:center;color:var(--muted);margin-top:12px;font-size:.95rem;">
        Note: This uses a serverless function to protect your API key. API calls are routed through a secure backend.
      </p>
    </div>
  </main>

  <script>
    // ============ CONFIGURATION ============
    // Update this URL to match your serverless function endpoint
    // For Vercel: https://your-project.vercel.app/api/youtube
    // For Netlify: https://your-site.netlify.app/.netlify/functions/youtube
    const SERVER_FUNCTION_URL = 'https://your-project.vercel.app/api/youtube';
    
    const channelId = 'UCVifvscpsdxwTWRXXnWsjYQ'; // DeBuDDi channel ID
    const maxResults = 9;

    const grid = document.getElementById('videos-grid');
    const iframe = document.getElementById('player-iframe');
    const refreshBtn = document.getElementById('refresh');
    let debugMode = true; // Set to false to hide debug info

    // ============ UTILITY FUNCTIONS ============
    function log(message, data = null) {
      console.log(`[DeBuDDi Videos] ${message}`, data || '');
    }

    function isoDateToLocal(dateStr) {
      try {
        const d = new Date(dateStr);
        return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
      } catch (e) {
        return dateStr;
      }
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, function(m) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
      });
    }

    function showError(message, details = '') {
      log('ERROR:', message);
      let html = `<div class="error-box"><strong>‚ö†Ô∏è Error:</strong> ${escapeHtml(message)}`;
      if (details) {
        html += `<div class="debug-info">${escapeHtml(details)}</div>`;
      }
      html += '</div>';
      grid.innerHTML = html;
      grid.setAttribute('aria-busy', 'false');
    }

    // ============ VIDEO RENDERING ============
    function renderThumbnails(items) {
      grid.innerHTML = '';
      grid.setAttribute('aria-busy', 'false');

      if (!items || items.length === 0) {
        grid.innerHTML = '<p style="padding:18px;color:var(--muted)">No videos found.</p>';
        return;
      }

      items.forEach((item, idx) => {
        try {
          const videoId = item.id?.videoId || item.videoId || '';
          const snippet = item.snippet || {};
          const title = snippet.title || 'Untitled';
          const thumbnails = snippet.thumbnails || {};
          const thumb = thumbnails.medium?.url || thumbnails.high?.url || thumbnails.default?.url || '';
          const date = snippet.publishedAt ? isoDateToLocal(snippet.publishedAt) : '';

          if (!videoId) {
            log(`Skipping item ${idx}: no videoId`);
            return;
          }

          const thumbElement = document.createElement('button');
          thumbElement.className = 'thumb';
          thumbElement.type = 'button';
          thumbElement.title = title;
          thumbElement.innerHTML = `
            <div class="play-overlay">
              <img src="${thumb}" alt="${escapeHtml(title)} thumbnail">
            </div>
            <div class="meta">
              <div style="flex:1;min-width:0">
                <div class="title">${escapeHtml(title)}</div>
                <div style="color:#bdbdbd;font-size:.82rem;margin-top:.35rem">${escapeHtml(date)}</div>
              </div>
              <div style="margin-left:8px;color:var(--muted);font-size:.82rem">#${idx + 1}</div>
            </div>
          `;

          thumbElement.addEventListener('click', () => {
            iframe.src = `https://www.youtube.com/embed/${videoId}?rel=0&modestbranding=1&autoplay=1`;
            iframe.focus();
          });

          grid.appendChild(thumbElement);
        } catch (err) {
          log(`Error rendering item ${idx}:`, err);
        }
      });

      // Set first video as player default
      const firstVideoId = items[0]?.id?.videoId || items[0]?.videoId || '';
      if (firstVideoId) {
        iframe.src = `https://www.youtube.com/embed/${firstVideoId}?rel=0&modestbranding=1`;
      }
    }

    // ============ FETCH VIDEOS ============
    async function fetchLatestVideos() {
      log('Fetching videos from:', SERVER_FUNCTION_URL);
      
      // Validate configuration
      if (SERVER_FUNCTION_URL.includes('your-project')) {
        showError(
          'Configuration Required',
          'Please update SERVER_FUNCTION_URL with your actual serverless function URL'
        );
        return;
      }

      grid.setAttribute('aria-busy', 'true');
      grid.innerHTML = '<p style="padding:18px;color:var(--muted)">Loading latest videos...</p>';

      try {
        const params = new URLSearchParams({
          channelId: channelId,
          maxResults: maxResults
        });

        const url = `${SERVER_FUNCTION_URL}?${params.toString()}`;
        log('Request URL:', url);

        const response = await fetch(url, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
          }
        });

        log('Response status:', response.status);

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(
            `HTTP ${response.status}: ${errorData.error || errorData.details || 'Unknown error'}`
          );
        }

        const data = await response.json();
        log('Videos fetched successfully:', data.items?.length);

        if (!data.items || data.items.length === 0) {
          showError('No videos found for this channel');
          return;
        }

        renderThumbnails(data.items);

      } catch (err) {
        log('Fetch error:', err);
        showError(
          'Failed to load videos',
          `${err.message}\n\nMake sure:\n1. SERVER_FUNCTION_URL is correct\n2. YouTube API key is set in serverless function\n3. Function is deployed and accessible`
        );
      }
    }

    // ============ EVENT LISTENERS ============
    refreshBtn.addEventListener('click', fetchLatestVideos);

    // ============ INITIAL LOAD ============
    log('Initializing video player');
    fetchLatestVideos();
  </script>
</body>
</html>
