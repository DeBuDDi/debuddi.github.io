<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Haikyuu Volleyball Lineup Builder</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:700,400&display=swap" rel="stylesheet">
  <style>
    /* ...all your existing styles... */
    /* Add touch-friendly style hints for mobile */
    @media (pointer:coarse), (max-width: 640px) {
      .upload-thumb, .char-img {
        cursor: pointer;
        touch-action: manipulation;
      }
      .drop-slot {
        min-width: 100px;
        min-height: 120px;
      }
    }
    /* Highlight for selection mode */
    .upload-thumb.selected, .char-img.selected {
      outline: 3px solid #e76f51 !important;
      box-shadow: 0 0 0 3px #ffd70088;
    }
    .drop-slot.slot-selectable {
      background: #fff4cc !important;
      border-color: #e76f51 !important;
      animation: slotPulse 0.8s infinite alternate;
    }
    @keyframes slotPulse {
      0% { box-shadow: 0 0 0 0 #ffd70066; }
      100% { box-shadow: 0 0 12px 7px #ffd70044; }
    }
  </style>
</head>
<body>
<!-- ...existing HTML structure (flyhigh-menu, container, lineup board, etc) ... -->
<!-- unchanged HTML body content -->
<script>
let uploadedImages = [];
let currentDragIndex = null;

// --- Upload Section ---
document.getElementById('img-upload').addEventListener('change', function(e) {
  for (let file of e.target.files) {
    let reader = new FileReader();
    reader.onload = function(evt) {
      uploadedImages.push(evt.target.result);
      renderUploaded();
      saveState(); // save images to localStorage when uploaded
    };
    reader.readAsDataURL(file);
  }
});

function renderUploaded() {
  const list = document.getElementById('upload-list');
  list.innerHTML = '';
  uploadedImages.forEach((src, i) => {
    let img = document.createElement('img');
    img.src = src;
    img.className = 'upload-thumb';
    img.draggable = true;
    img.ondragstart = () => currentDragIndex = i;
    img.title = 'Drag to lineup';
    // --- Touch selection for mobile ---
    img.addEventListener('touchstart', function(e) {
      e.preventDefault();
      startSelectionMode('image', i);
    });
    // --- Click selection for desktop fallback ---
    img.addEventListener('click', function(e) {
      if (window.matchMedia('(pointer:coarse)').matches) {
        startSelectionMode('image', i);
      }
    });
    list.appendChild(img);
  });
}

function makeLabel(label, onEdit) {
  let labelDiv = document.createElement('div');
  labelDiv.className = 'player-label';
  labelDiv.innerText = label || "Click to Edit";
  labelDiv.onclick = function(e) {
    e.stopPropagation();
    let input = document.createElement('input');
    input.type = 'text';
    input.value = labelDiv.innerText === "Click to Edit" ? "" : labelDiv.innerText;
    input.className = 'label-edit';
    input.onblur = function() {
      labelDiv.innerText = input.value || "Click to Edit";
      onEdit(labelDiv.innerText);
      labelDiv.style.display = '';
      input.remove();
    };
    input.onkeydown = function(ev) {
      if(ev.key === 'Enter') input.blur();
    };
    labelDiv.style.display = 'none';
    labelDiv.parentNode.insertBefore(input, labelDiv);
    input.focus();
  };
  return labelDiv;
}

function getInitialLabels() {
  return {
    '0': '', '1': '', '2': '', '3': '', '4': '', '5': '',
    'coach': '',
    'sub0': '', 'sub1': '', 'sub2': '', 'sub3': '', 'sub4': '', 'sub5': ''
  }
}
let slotLabels = getInitialLabels();
let slotImages = {};

// --- Save/load state with uploads ---
function saveState() {
  let state = { slotLabels, slotImages, uploadedImages };
  window.localStorage.setItem('haikyuu_lineup_state', JSON.stringify(state));
}
function loadState() {
  let state = window.localStorage.getItem('haikyuu_lineup_state');
  if (state) {
    try {
      let { slotLabels: l, slotImages: i, uploadedImages: imgs } = JSON.parse(state);
      slotLabels = l || getInitialLabels();
      slotImages = i || {};
      uploadedImages = imgs || [];
      renderUploaded();
      document.querySelectorAll('.drop-slot').forEach(slot => renderSlot(slot));
    } catch {}
  }
}
loadState();

document.querySelectorAll('.drop-slot').forEach(slot => {
  slot.ondragover = e => { e.preventDefault(); slot.classList.add('dragover'); };
  slot.ondragleave = () => slot.classList.remove('dragover');
  slot.ondrop = function(e) {
    e.preventDefault(); slot.classList.remove('dragover');
    if (currentDragIndex !== null && uploadedImages[currentDragIndex]) {
      setSlotImage(slot, uploadedImages[currentDragIndex]);
    }
    else if (window._draggingSlot && window._draggingSlot !== slot) {
      setSlotImage(slot, slotImages[window._draggingSlot.dataset.slot], slotLabels[window._draggingSlot.dataset.slot]);
      clearSlot(window._draggingSlot);
    }
    currentDragIndex = null;
    window._draggingSlot = null;
  };
  slot.addEventListener('mousedown', function(e) {
    if(e.target.classList.contains('char-img')) {
      window._draggingSlot = slot;
    }
  });
  // --- Touch and click for slot selection ---
  slot.addEventListener('touchstart', function(e) {
    if (window._selectionMode && window._selectionType === 'image') {
      e.preventDefault();
      finishSelectionMode(slot);
    } else if (window._selectionMode && window._selectionType === 'slot') {
      e.preventDefault();
      startSelectionMode('slot', slot.dataset.slot);
    }
  });
  slot.addEventListener('click', function(e) {
    if (window.matchMedia('(pointer:coarse)').matches && window._selectionMode && window._selectionType === 'image') {
      finishSelectionMode(slot);
    }
  });
  renderSlot(slot);
});

function setSlotImage(slot, imgSrc, label) {
  slot.innerHTML = '';
  let slotKey = slot.dataset.slot;
  slotImages[slotKey] = imgSrc;
  slotLabels[slotKey] = label || slotLabels[slotKey] || '';
  let img = document.createElement('img');
  img.src = imgSrc;
  img.className = 'char-img';
  img.draggable = true;
  img.ondragstart = function(e) {
    window._draggingSlot = slot;
    currentDragIndex = null;
    e.dataTransfer.setData('text/plain', '');
  };
  // --- Touch selection for moving character in slot ---
  img.addEventListener('touchstart', function(e) {
    if (window.matchMedia('(pointer:coarse)').matches) {
      e.preventDefault();
      startSelectionMode('slot', slotKey);
    }
  });
  img.addEventListener('click', function(e) {
    if (window.matchMedia('(pointer:coarse)').matches) {
      startSelectionMode('slot', slotKey);
    }
  });
  slot.appendChild(img);

  let labelDiv = makeLabel(slotLabels[slotKey], val => {
    slotLabels[slotKey] = val;
    saveState();
  });
  slot.appendChild(labelDiv);

  let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
  if (slotType) {
    slot.insertBefore(slotType, slot.firstChild);
  }
  saveState();
}
function clearSlot(slot) {
  let slotKey = slot.dataset.slot;
  slot.innerHTML = '';
  slotImages[slotKey] = null;
  slotLabels[slotKey] = '';
  let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
  if (slotType) {
    slot.appendChild(slotType);
  }
}

function renderSlot(slot) {
  let slotKey = slot.dataset.slot;
  slot.innerHTML = '';
  if(slotImages[slotKey]) {
    setSlotImage(slot, slotImages[slotKey], slotLabels[slotKey]);
  } else {
    let slotType = slot.querySelector('.slot-type-label')?.cloneNode(true);
    if (slotType) slot.appendChild(slotType);
  }
}

// --- Selection mode for mobile/tablet drag-and-drop alternative ---
window._selectionMode = false;
window._selectionType = null;
window._selectionIndex = null;

function startSelectionMode(type, index) {
  cancelSelectionMode();
  window._selectionMode = true;
  window._selectionType = type; // 'image' or 'slot'
  window._selectionIndex = index;
  // highlight the selected thumb or char-img
  if (type === 'image') {
    document.querySelectorAll('.upload-thumb').forEach((img, i) => {
      img.classList.toggle('selected', i === index);
    });
    // highlight all drop-slots as selectable
    document.querySelectorAll('.drop-slot').forEach(slot => slot.classList.add('slot-selectable'));
  } else if (type === 'slot') {
    // highlight the selected slot's image
    Object.entries(slotImages).forEach(([k, v]) => {
      let slot = document.querySelector(`.drop-slot[data-slot="${k}"]`);
      if (slot && v) {
        let img = slot.querySelector('.char-img');
        if (img) img.classList.toggle('selected', k == index);
      }
    });
    // highlight all drop-slots as selectable
    document.querySelectorAll('.drop-slot').forEach(slot => slot.classList.add('slot-selectable'));
  }
}

function finishSelectionMode(targetSlot) {
  if (!window._selectionMode) return;
  if (window._selectionType === 'image' && typeof window._selectionIndex === 'number') {
    // Assign selected uploaded image to this slot
    setSlotImage(targetSlot, uploadedImages[window._selectionIndex]);
  } else if (window._selectionType === 'slot' && window._selectionIndex) {
    // Move character from selected slot to this slot
    let fromSlot = window._selectionIndex;
    setSlotImage(targetSlot, slotImages[fromSlot], slotLabels[fromSlot]);
    let oldSlot = document.querySelector(`.drop-slot[data-slot="${fromSlot}"]`);
    if (oldSlot) clearSlot(oldSlot);
  }
  saveState();
  cancelSelectionMode();
}

function cancelSelectionMode() {
  window._selectionMode = false;
  window._selectionType = null;
  window._selectionIndex = null;
  // Remove all highlights
  document.querySelectorAll('.upload-thumb, .char-img').forEach(el => el.classList.remove('selected'));
  document.querySelectorAll('.drop-slot').forEach(slot => slot.classList.remove('slot-selectable'));
}

// Cancel selection when tapping outside
document.body.addEventListener('touchstart', function(e) {
  if (window._selectionMode) {
    let isThumb = e.target.classList.contains('upload-thumb');
    let isCharImg = e.target.classList.contains('char-img');
    let isSlot = e.target.classList.contains('drop-slot');
    if (!isThumb && !isCharImg && !isSlot) cancelSelectionMode();
  }
}, {passive:true});
document.body.addEventListener('mousedown', function(e) {
  if (window._selectionMode) {
    let isThumb = e.target.classList.contains('upload-thumb');
    let isCharImg = e.target.classList.contains('char-img');
    let isSlot = e.target.classList.contains('drop-slot');
    if (!isThumb && !isCharImg && !isSlot) cancelSelectionMode();
  }
});

// --- Existing reset/save handlers ---
function resetLineup() {
  slotLabels = getInitialLabels();
  slotImages = {};
  document.querySelectorAll('.drop-slot').forEach(slot => renderSlot(slot));
  saveState();
}

function saveCurrentLineup() {
  saveState();
  alert('Your current lineup, uploads, and edits have been saved!');
}
</script>
</body>
</html>
